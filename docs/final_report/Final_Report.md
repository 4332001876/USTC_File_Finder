# 大数据系统实验

## 组员名单及具体分工

- PB21030838 罗浩铭:负责整体框架的搭建，以及检索部分（包括传统查询数据库elastic search, 向量查询数据库milvus的搭建与交互），并完成了项目在云服务器上的部署，以及上台答辩
- PB21061199 范晨晓:负责爬虫部分（包括设置对不同网页的遍历方式控制），以及对网页数据的解析与存储
- PB21151807 刘海琳:负责hbase数据库的搭建与交互部分，前端搭建，以及答辩PPT制作


## 技术路线
### 概述
我们基于HBase, ElasticSearch, Milvus等框架及其Python API实现了一个文件查询系统，用于查找中科大各校内网站的在线文件。我们使用爬虫来从各个网站爬取各文件的标题、URL、日期、来源等信息，并将这些信息存储到HBase数据库中，同时在ElasticSearch搜索引擎与Milvus向量查询数据库建立查询索引。我们使用ElasticSearch来对文件的标题、来源等信息进行检索，同时使用Milvus来对文件标题的embedding进行向量查询以扩展搜索结果。最终我们使用gradio框架搭建了一个简单的前端，用于接收用户的查询请求，并美观地展示查询结果。网站已经在云服务器上部署，可以通过[USTC File Finder](http://47.76.73.185:7860/)来访问。

<img src="./pic/final_website.png" width="100%" style="margin: 0 auto;">

### 代码框架
源代码框架如下：

```txt
USTC_File_Finder
├── docs # 文档
├── src # 源代码
│   ├── crawler # 爬虫
│   ├── data_access # 数据库访问接口
│   ├── server # 后端
|   ├── config.py # 配置信息，整个项目的配置信息都在这里
|   ├── main.py # 项目入口
|   └── test.py # 测试代码，定义了一个Tester.py类，用于测试各个模块的功能
```

其中`crawler`包含了爬虫部分的代码，`data_access`包含了HBase数据库访问及ElasticSearch与Milvus查询的代码，`server`包含了前端及其所需后端逻辑的代码，`config.py`包含了整个项目的配置信息，`main.py`是项目的入口，`test.py`包含了测试代码，定义了一个`Tester.py`类，用于测试各个模块的功能。

### 爬虫


各个网站爬取的文件数量如下：
|          网站          | 文件数 |
| :--------------------: | :----: |
|         教务处         |  854   |
|        研究生院        |  253   |
|        软件学院        |  177   |
|     先进技术研究院     |  139   |
|      网络信息中心      |   91   |
|    国际合作与交流部    |   75   |
|        超算中心        |   71   |
|        学工在线        |   58   |
|    信息科学技术学院    |   43   |
|         出版社         |   39   |
|     苏州高等研究院     |   35   |
|    资产与后勤保障处    |   30   |
|   计算机科学技术学院   |   23   |
|    保卫与校园管理处    |   17   |
|    信息科学实验中心    |   16   |
| 科技成果转移转化办公室 |   15   |
|    网络空间安全学院    |   14   |
|       大数据学院       |   7    |
|      工程科学学院      |   7    |




### hbase数据库
我们基于Python的happybase库，并借助HBase的Thrift服务，来实现我们的项目与HBase数据库之间的交互。

我们实现了一个`HbaseHelper`类，用来管理与HBase数据库之间的连接与增删改查操作。我们还实现了以我们项目定义的`FileRecord`文件信息类为API的数据库交互函数，包括将`FileRecord`对象存入HBase数据库或覆盖HBase数据库中原有条目的`put_file`函数，以及将HBase数据库中读出数据转换为`FileRecord`对象的`get_file`函数。

数据库内存储的内容结构如下：

在列族`info`中我们存储了如下文件信息：

|    列名     |          信息          |
| :---------: | :--------------------: |
|    title    |        文件标题        |
|     url     |        文件URL         |
|    time     |      文件发布时间      |
|   source    |        文件来源        |
|  file_type  | 文件在网站中的一级类型 |
| file_type_2 | 文件在网站中的二级类型 |

在列`counter:increment_id`的`row_increment_id`行中我们存储了一个自增计数器，用于将row_key命名为`f'row_{increment_id}'`，这将保证各文件的row_key不同，同时这些row_key将用来关联HBase数据库与其它查询数据库。



### elastic search
由于HBase对搜索功能几乎没有支持，因此我们使用ElasticSearch来对文件的标题、来源等信息进行检索。Elasticsearch是一个分布式、RESTful风格的搜索和数据分析引擎，支持分词查询、模糊查询、查询结果排序，非常适用于当前文本查询的场景。由于其原生支持分布式部署，因此可以保证我们项目的可扩展性。
我们使用Python的ElasticSearch库来实现我们的项目与ElasticSearch搜索引擎之间的交互。

我们实现了`ElasticsearchHelper`类，用来管理ElasticSearch的增删改查操作。

搜索结果以row_key的形式与原HBase数据库关联。


### milvus数据库
在尝试传统查询框架的同时，我们也尝试了向量查询框架。我们使用Milvus向量查询数据库来对文件标题的embedding进行向量查询以扩展搜索结果。
Milvus 是一个云原生的向量数据库，具有以下特点：
高性能：性能高超，完成万亿条向量数据搜索的平均延迟以毫秒计
高可用、高可靠、高可扩展性：支持分布式部署，具有高容错容灾能力
功能强大：增量数据摄取、标量向量混合查询、time travel 等

由于其原生支持分布式部署，因此可以保证我们项目的可扩展性。

我们实现了`TitleToVec`类，对每一个标题用BERT处理，并以BERT的`pooler output`（`[cls]` token对应位置的输出token，包含了整个句子的语义信息）作为标题的sentence embedding。我们就以该标题的embedding作为Milvus向量查询数据库的索引，并以查询关键词的embedding作为查询向量，来对标题进行向量查询。

搜索结果以row_key的形式与原HBase数据库关联。


### 搜索引擎管理
我们实现了一个`SearchEngine`类，用来ElasticSearch与Milvus向量数据库的查询，整合多来源的查询结果，并以查询得到的条目的row_key从HBase数据库中读出数据。

### 前端
我们使用了gradio框架搭建了一个简单的前端，用于接收用户的查询请求，并美观地展示查询结果。


网站已经在云服务器上部署，其网址为：http://47.76.73.185:7860/
欢迎大家访问和体验！

## 实现功能介绍




## 核心代码块
实验报告要求的


## 组员总结与心得
### 罗浩铭
我实现了

在这次实验中，我磨练了我使用各大数据框架的技术，提高了我对大数据系统特别是搜索引擎等技术的理解。相信在数据处理需求日益

### 范晨晓



### 刘海琳
